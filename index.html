<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>IPTV工具集 - 多功能版（含MT编码转换）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Roboto", "Microsoft YaHei", sans-serif;
        }
        body {
            background: #f5f5f5;
            padding: 10px;
            max-width: 100%;
            margin: 0 auto;
            font-size: 14px;
        }
        /* 面板切换 - 移动端滚动适配 + 增强3D效果 */
        .tab-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            width: 100%;
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: thin;
        }
        .tab-group::-webkit-scrollbar {
            height: 3px;
        }
        .tab-group::-webkit-scrollbar-thumb {
            background: #1677ff;
            border-radius: 2px;
        }
        .tab-btn {
            flex: 0 0 auto;
            padding: 10px 16px;
            border-radius: 8px;
            color: #333;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            border: none;
            cursor: pointer;
            /* 增强3D：渐变底色 + 多层阴影 */
            background: linear-gradient(145deg, #f0f0f0, #e0e0e0);
            box-shadow: 
                0 6px 0 0 #cccccc,
                0 8px 15px rgba(0,0,0,0.15);
            transition: all 0.15s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        .tab-btn.active {
            color: #fff;
            background: linear-gradient(145deg, #188fff, #1677ff);
            box-shadow: 
                0 6px 0 0 #0e5bd8,
                0 8px 15px rgba(22, 119, 255, 0.3);
        }
        .tab-btn:active {
            transform: translateY(4px);
            box-shadow: 
                0 2px 0 0 #cccccc,
                0 4px 8px rgba(0,0,0,0.1);
        }
        .tab-btn.active:active {
            box-shadow: 
                0 2px 0 0 #0e5bd8,
                0 4px 8px rgba(22, 119, 255, 0.2);
        }
        /* 面板容器 - 移动端内边距优化 */
        .panel-container {
            width: 100%;
        }
        .panel {
            display: none;
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,.08);
            margin-bottom: 10px;
        }
        .panel.active {
            display: block;
        }
        h1 {
            font-size: 18px;
            text-align: center;
            margin-bottom: 15px;
            color: #333;
            font-weight: 600;
        }
        /* 通用输入项样式 */
        .input-item {
            margin-bottom: 12px;
            width: 100%;
        }
        .input-item label {
            font-size: 13px;
            color: #555;
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
            font-size: 14px;
            transition: border 0.2s;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #1677ff;
            box-shadow: 0 0 0 2px rgba(22, 119, 255, 0.1);
        }
        textarea {
            min-height: 200px;
            resize: vertical;
            line-height: 1.5;
            font-family: "Consolas", "Monaco", monospace;
        }
        /* 复选框样式 */
        .checkbox-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 13px;
            color: #555;
        }
        .checkbox-item input {
            margin-right: 8px;
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }
        /* 按钮组 - 移动端适配 + 增强3D效果 */
        .btn-group {
            display: flex;
            gap: 6px;
            margin: 12px 0;
            width: 100%;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 12px;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            flex: 1;
            min-width: 80px;
            border: none;
            cursor: pointer;
            /* 增强3D：渐变 + 多层阴影 + 按压反馈 */
            background: linear-gradient(145deg, #188fff, #1677ff);
            box-shadow: 
                0 6px 0 0 #0e5bd8,
                0 8px 15px rgba(22, 119, 255, 0.3);
            transition: all 0.15s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        button.blue {
            background: linear-gradient(145deg, #188fff, #1677ff);
            box-shadow: 
                0 6px 0 0 #0e5bd8,
                0 8px 15px rgba(22, 119, 255, 0.3);
        }
        button.red {
            background: linear-gradient(145deg, #ff5a5f, #ff4d4f);
            box-shadow: 
                0 6px 0 0 #d93638,
                0 8px 15px rgba(255, 77, 79, 0.3);
        }
        button.green {
            background: linear-gradient(145deg, #58d91a, #52c41a);
            box-shadow: 
                0 6px 0 0 #389e0d,
                0 8px 15px rgba(82, 196, 26, 0.3);
        }
        button.gray {
            background: linear-gradient(145deg, #999999, #8c8c8c);
            box-shadow: 
                0 6px 0 0 #666666,
                0 8px 15px rgba(140, 140, 140, 0.3);
        }
        button:active {
            transform: translateY(4px);
            box-shadow: 
                0 2px 0 0 rgba(0,0,0,0.2),
                0 4px 8px rgba(0,0,0,0.1);
        }
        /* 上传区域 */
        .upload {
            margin: 12px 0;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .upload-input-label {
            padding: 10px 16px;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            background: linear-gradient(145deg, #188fff, #1677ff);
            box-shadow: 
                0 6px 0 0 #0e5bd8,
                0 8px 15px rgba(22, 119, 255, 0.3);
            transition: all 0.15s ease-in-out;
        }
        .upload-input-label:active {
            transform: translateY(4px);
            box-shadow: 
                0 2px 0 0 #0e5bd8,
                0 4px 8px rgba(22, 119, 255, 0.2);
        }
        .file-name-display {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: #fafafa;
        }
        /* LOGO搜索模块 */
        .logo-search {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .search-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            width: 100%;
        }
        .search-bar input {
            flex: 1;
        }
        .loading {
            text-align: center;
            color: #1677ff;
            font-size: 13px;
            padding: 15px 0;
            display: none;
        }
        .logo-result {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 8px;
            display: none;
        }
        .logo-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-bottom: 1px solid #f5f5f5;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .logo-item:hover {
            background: #f8f9fa;
        }
        .logo-item:last-child {
            border-bottom: none;
        }
        .logo-item .preview {
            width: 40px;
            height: 25px;
            border: 1px solid #eee;
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
        }
        .logo-item .preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .logo-item .info {
            flex: 1;
        }
        .logo-item .name {
            font-size: 13px;
            color: #333;
            margin-bottom: 2px;
        }
        .logo-item .url {
            font-size: 11px;
            color: #666;
            word-break: break-all;
        }
        .logo-item .copy-btn {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
            background: linear-gradient(145deg, #188fff, #1677ff);
            color: #fff;
            border: none;
            cursor: pointer;
            box-shadow: 
                0 3px 0 0 #0e5bd8,
                0 4px 6px rgba(22, 119, 255, 0.2);
            transition: all 0.15s ease-in-out;
        }
        .logo-item .copy-btn:active {
            transform: translateY(2px);
            box-shadow: 
                0 1px 0 0 #0e5bd8,
                0 2px 3px rgba(22, 119, 255, 0.1);
        }
        /* MT管理器工具按钮组 + 增强3D效果 */
        .mt-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 10px 0;
        }
        .mt-tool-btn {
            padding: 8px 10px;
            font-size: 12px;
            border-radius: 6px;
            color: #333;
            border: none;
            cursor: pointer;
            flex: 1;
            min-width: 60px;
            background: linear-gradient(145deg, #f0f0f0, #e0e0e0);
            box-shadow: 
                0 4px 0 0 #cccccc,
                0 6px 8px rgba(0,0,0,0.1);
            transition: all 0.15s ease-in-out;
        }
        .mt-tool-btn:active {
            transform: translateY(3px);
            box-shadow: 
                0 1px 0 0 #cccccc,
                0 2px 4px rgba(0,0,0,0.1);
        }
        /* 弹窗样式 - 增强悬浮感 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            width: 90%;
            max-width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-title {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }
        .modal-btns {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        /* 编码转换弹窗额外样式 */
        .charset-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .charset-row select {
            flex: 1;
        }
    </style>
</head>
<body>
    <!-- 面板切换按钮 -->
    <div class="tab-group">
        <button class="tab-btn active" onclick="switchTab('iptv-panel')">IPTV文件转换</button>
        <button class="tab-btn" onclick="switchTab('logo-panel')">LOGO模糊搜索</button>
        <button class="tab-btn" onclick="switchTab('mt-panel')">MT管理器</button>
    </div>

    <!-- 面板容器 -->
    <div class="panel-container">
        <!-- ========== IPTV面板（完全保留原有功能） ========== -->
        <div class="panel active" id="iptv-panel">
            <h1>IPTV工具集 - 文件转换</h1>
            <div class="input-item">
                <label>EPG 地址</label>
                <input id="epgUrl" placeholder="请输入EPG地址" value="https://epg.catvod.com/epg.xml">
            </div>
            <div class="input-item">
                <label>Logo 基础地址（结尾 /）</label>
                <input id="logoUrlInput" placeholder="请输入Logo基础地址" value="https://gcore.jsdelivr.net/gh/taksssss/tv/icon/">
            </div>
            <div class="input-item">
                <label>自定义净化关键词</label>
                <input id="customCleanKeywords" placeholder="多个关键词用英文逗号分隔，如:测试,备用,无效">
                <div style="font-size:12px;color:#999;margin-top:2px;">提示：输入后会和默认关键词（高清|HD|超清）一起过滤频道名</div>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="cleanName" checked>
                <label>净化频道名</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="removeReplay" checked>
                <label>去除回看/回放/时移频道</label>
            </div>
            <div class="input-item">
                <label>旧链接前缀</label>
                <input id="oldLinkPrefix" placeholder="如http://old.example.com/">
            </div>
            <div class="input-item">
                <label>新链接前缀</label>
                <input id="newLinkPrefix" placeholder="如https://new.example.com/">
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="enableLinkReplace" checked>
                <label>启用链接前缀替换</label>
            </div>
            <div class="upload">
                <label for="fileInput" class="upload-input-label">选择文件</label>
                <input type="file" id="fileInput" accept=".txt,.m3u,.m3u8" style="display: none;" onchange="readFile(this)">
                <div class="file-name-display" id="fileNameDisplay">未选择文件</div>
            </div>
            <div class="input-item">
                <label>输入内容</label>
                <textarea id="inputContent" placeholder="粘贴TXT/M3U/M3U8格式的直播源内容"></textarea>
            </div>
            <div class="btn-group">
                <button class="blue" onclick="txtToM3u()">TXT → M3U</button>
                <button class="blue" onclick="m3uToTxt()">M3U → TXT</button>
                <button class="blue" onclick="onlyReplaceLink()">只替换链接</button>
                <button class="red" onclick="clearAll()">清空内容</button>
            </div>
            <div class="input-item">
                <label>输出结果</label>
                <textarea id="output" placeholder="处理后的结果将显示在这里" readonly></textarea>
            </div>
            <div class="btn-group">
                <button class="green" onclick="downloadResult()">下载结果</button>
                <button class="green" onclick="copyResult()">复制结果</button>
            </div>
            <div style="font-size:12px;color:#999;text-align:center;margin-top:8px;">安卓手机请开启浏览器存储权限</div>
        </div>

        <!-- ========== LOGO搜索面板（完全保留原有功能） ========== -->
        <div class="panel" id="logo-panel">
            <h1>IPTV工具集 - LOGO搜索</h1>
            <div class="logo-search">
                <h3 style="font-size:15px;margin-bottom:10px;">频道LOGO模糊搜索</h3>
                <div class="search-bar">
                    <input type="text" id="searchKey" placeholder="输入关键词（如CCTV、4K）">
                    <button class="blue" onclick="fuzzySearchLogo()">搜索</button>
                </div>
                <div class="loading" id="loading">正在搜索...</div>
                <div id="logoResult" class="logo-result"></div>
            </div>
        </div>

        <!-- ========== MT管理器面板（新增编码转换功能） ========== -->
        <div class="panel" id="mt-panel">
            <h1>MT管理器 - 文本编辑工具</h1>
            <!-- 文件操作区 -->
            <div class="input-item">
                <label>文件名</label>
                <input id="mtFileName" placeholder="输入文件名，如script.js" value="iptv_script.js">
            </div>
            <div class="upload">
                <label for="mtFileInput" class="upload-input-label">导入文件</label>
                <input type="file" id="mtFileInput" style="display: none;" onchange="readMtFile(this)">
                <div class="file-name-display" id="mtFileNameDisplay">未选择文件</div>
            </div>
            <!-- 编码选择 -->
            <div class="input-item">
                <label>当前文件编码</label>
                <select id="mtCharset">
                    <option value="utf-8">UTF-8</option>
                    <option value="gbk">GBK</option>
                    <option value="gb2312">GB2312</option>
                    <option value="ascii">ASCII</option>
                </select>
            </div>
            <!-- 核心编辑区 -->
            <div class="input-item">
                <label>编辑内容</label>
                <textarea id="mtEditContent" placeholder="粘贴文本/代码内容，支持安卓MT常用编辑操作"></textarea>
            </div>
            <!-- MT核心工具按钮组 -->
            <div class="mt-tools">
                <button class="mt-tool-btn" onclick="mtSelectAll()">全选</button>
                <button class="mt-tool-btn" onclick="mtCopy()">复制</button>
                <button class="mt-tool-btn" onclick="mtCut()">剪切</button>
                <button class="mt-tool-btn" onclick="mtPaste()">粘贴</button>
                <button class="mt-tool-btn" onclick="mtUndo()">撤销</button>
                <button class="mt-tool-btn" onclick="mtRedo()">重做</button>
                <button class="mt-tool-btn" onclick="mtFind()">查找</button>
                <button class="mt-tool-btn" onclick="mtReplace()">替换</button>
                <button class="mt-tool-btn" onclick="mtFormatJson()">格式化JSON</button>
                <button class="mt-tool-btn" onclick="mtMinify()">代码压缩</button>
                <button class="mt-tool-btn" onclick="mtLineCount()">统计行数</button>
                <button class="mt-tool-btn" onclick="openCharsetModal()">编码转换</button>
            </div>
            <!-- 保存/导出按钮 -->
            <div class="btn-group">
                <button class="green" onclick="mtSaveFile()">保存文件</button>
                <button class="blue" onclick="mtNewFile()">新建文件</button>
                <button class="red" onclick="mtClearContent()">清空内容</button>
            </div>
        </div>
    </div>

    <!-- 查找替换弹窗 -->
    <div class="modal" id="findReplaceModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">查找</div>
            <div class="input-item">
                <label>查找内容</label>
                <input type="text" id="findText" placeholder="输入要查找的文本">
            </div>
            <div class="input-item" id="replaceInputWrap" style="display: none;">
                <label>替换为</label>
                <input type="text" id="replaceText" placeholder="输入替换后的文本">
            </div>
            <div class="modal-btns">
                <button class="blue" id="findBtn" onclick="doFind()">查找下一个</button>
                <button class="blue" id="replaceBtn" style="display: none;" onclick="doReplace()">替换</button>
                <button class="blue" id="replaceAllBtn" style="display: none;" onclick="doReplaceAll()">全部替换</button>
                <button class="gray" onclick="closeModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 编码转换弹窗 -->
    <div class="modal" id="charsetModal">
        <div class="modal-content">
            <div class="modal-title">文本编码转换</div>
            <div class="charset-row">
                <select id="charsetFrom">
                    <option value="utf-8">原编码 - UTF-8</option>
                    <option value="gbk">原编码 - GBK</option>
                    <option value="gb2312">原编码 - GB2312</option>
                    <option value="ascii">原编码 - ASCII</option>
                </select>
            </div>
            <div class="charset-row">
                <select id="charsetTo">
                    <option value="gbk">目标编码 - GBK</option>
                    <option value="gb2312">目标编码 - GB2312</option>
                    <option value="ascii">目标编码 - ASCII</option>
                    <option value="utf-8">目标编码 - UTF-8</option>
                </select>
            </div>
            <div class="modal-btns">
                <button class="blue" onclick="convertCharset()">执行转换</button>
                <button class="gray" onclick="closeModal()">取消</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/iconv-lite@0.6.3/lib/index.min.js"></script>
    <script>
        // ========== IPTV 原有核心配置（完全未修改） ==========
        const repoOwner = "1996TV";
        const repoName = "LOGO";
        const cdnBase = `https://cdn.jsdelivr.net/gh/${repoOwner}/${repoName}@main/`;
        let allLogoFiles = [];
        const DEFAULT_EPG_URL = "https://epg.catvod.com/epg.xml";
        const DEFAULT_LOGO_URL = "https://gcore.jsdelivr.net/gh/taksssss/tv/icon/";
        const DEFAULT_CLEAN_KEYWORDS = ["高清", "HD", "超清"];

        // 面板切换函数
        function switchTab(panelId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(panelId).classList.add('active');
        }

        // ========== IPTV 原有功能函数（完全未修改） ==========
        window.onload = function() {
            // IPTV 初始化
            document.getElementById('epgUrl').value = DEFAULT_EPG_URL;
            document.getElementById('logoUrlInput').value = DEFAULT_LOGO_URL;
            document.getElementById('fileNameDisplay').textContent = "未选择文件";
            document.getElementById('cleanName').checked = true;
            document.getElementById('removeReplay').checked = true;
            document.getElementById('enableLinkReplace').checked = true;
            // MT 初始化
            mtRecordHistory();
        };

        function readFile(input) {
            if (!input.files.length) return;
            const file = input.files[0];
            document.getElementById('fileNameDisplay').textContent = file.name;
            const reader = new FileReader();
            reader.onload = e => document.getElementById('inputContent').value = e.target.result;
            reader.readAsText(file);
        }

        function cleanNameFn(name) {
            if (!document.getElementById('cleanName').checked) return name;
            const custom = document.getElementById('customCleanKeywords').value.split(',').filter(k => k);
            [...DEFAULT_CLEAN_KEYWORDS, ...custom].forEach(k => name = name.replace(k, '').trim());
            return name;
        }

        function isReplay(name) {
            return ['回看', '回放', '时移', '录播'].some(k => name.includes(k));
        }

        function txtToM3u() {
            const input = document.getElementById('inputContent').value.trim();
            if (!input) return alert('请输入TXT内容！');
            const epg = document.getElementById('epgUrl').value.trim();
            const logoBase = document.getElementById('logoUrlInput').value.trim().replace(/\/$/, '') + '/';
            let output = `#EXTM3U x-tvg-url="${epg}"\n`;
            input.split('\n').forEach(line => {
                const [name, url] = line.split(',').map(i => i.trim());
                if (!name || !url) return;
                if (document.getElementById('removeReplay').checked && isReplay(name)) return;
                const cleanName = cleanNameFn(name);
                output += `#EXTINF:-1 tvg-name="${cleanName}" tvg-logo="${logoBase}${cleanName}.png",${cleanName}\n${url}\n`;
            });
            document.getElementById('output').value = output;
            alert('TXT转M3U成功！');
        }

        function m3uToTxt() {
            const input = document.getElementById('inputContent').value.trim();
            if (!input.startsWith('#EXTM3U')) return alert('请输入M3U内容！');
            let output = '', currentName = '';
            input.split('\n').forEach(line => {
                line = line.trim();
                if (line.startsWith('#EXTINF')) {
                    const match = line.match(/,(.*)$/);
                    currentName = match ? cleanNameFn(match[1].trim()) : '';
                    if (document.getElementById('removeReplay').checked && isReplay(currentName)) currentName = '';
                } else if (line && !line.startsWith('#') && currentName) {
                    output += `${currentName},${line}\n`;
                    currentName = '';
                }
            });
            document.getElementById('output').value = output.trim();
            alert('M3U转TXT成功！');
        }

        function onlyReplaceLink() {
            const input = document.getElementById('inputContent').value.trim();
            const oldPre = document.getElementById('oldLinkPrefix').value.trim();
            const newPre = document.getElementById('newLinkPrefix').value.trim();
            if (!input) return alert('请输入内容！');
            if (!oldPre || !newPre) return alert('请填写新旧链接前缀！');
            document.getElementById('output').value = input.replace(new RegExp(oldPre, 'g'), newPre);
            alert('链接替换成功！');
        }

        function clearAll() {
            document.getElementById('inputContent').value = '';
            document.getElementById('output').value = '';
            document.getElementById('fileNameDisplay').textContent = "未选择文件";
            document.getElementById('fileInput').value = '';
            alert('内容已清空！');
        }

        function downloadResult() {
            const content = document.getElementById('output').value.trim();
            if (!content) return alert('暂无内容可下载！');
            const ext = content.startsWith('#EXTM3U') ? 'm3u' : 'txt';
            const blob = new Blob([content], { type: 'application/octet-stream' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `iptv_result.${ext}`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function copyResult() {
            const content = document.getElementById('output').value.trim();
            if (!content) return alert('暂无内容可复制！');
            navigator.clipboard.writeText(content).then(() => alert('复制成功！'))
                .catch(() => {
                    const ta = document.createElement('textarea');
                    ta.value = content;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    alert('复制成功！');
                });
        }

        async function fuzzySearchLogo() {
            const key = document.getElementById('searchKey').value.trim().toLowerCase();
            if (!key) return alert('请输入搜索关键词！');
            const loading = document.getElementById('loading');
            const resultBox = document.getElementById('logoResult');
            loading.style.display = 'block';
            resultBox.style.display = 'none';
            try {
                if (!allLogoFiles.length) {
                    const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/`);
                    if (!res.ok) throw new Error(`请求失败 ${res.status}`);
                    allLogoFiles = (await res.json()).filter(f => f.name.endsWith('.png') || f.name.endsWith('.jpg'));
                }
                const matches = allLogoFiles.filter(f => f.name.toLowerCase().includes(key));
                loading.style.display = 'none';
                if (!matches.length) {
                    resultBox.innerHTML = '<p style="font-size:13px;color:#999;padding:10px;text-align:center;">未找到匹配LOGO</p>';
                    resultBox.style.display = 'block';
                    return;
                }
                let html = '';
                matches.forEach(f => {
                    const name = f.name.split('.')[0];
                    const url = cdnBase + f.name;
                    html += `
                        <div class="logo-item">
                            <div class="preview"><img src="${url}" alt="${name}"></div>
                            <div class="info">
                                <div class="name">${name}</div>
                                <div class="url">${url}</div>
                            </div>
                            <button class="copy-btn" onclick="copyLogoUrl('${url}')">复制</button>
                        </div>
                    `;
                });
                resultBox.innerHTML = html;
                resultBox.style.display = 'block';
            } catch (e) {
                loading.style.display = 'none';
                resultBox.innerHTML = `<p style="font-size:13px;color:#ff4d4f;padding:10px;text-align:center;">搜索失败：${e.message}</p>`;
                resultBox.style.display = 'block';
            }
        }

        function copyLogoUrl(url) {
            navigator.clipboard.writeText(url).then(() => alert('LOGO链接复制成功！'))
                .catch(() => {
                    const ta = document.createElement('textarea');
                    ta.value = url;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    alert('LOGO链接复制成功！');
                });
        }

        // ========== MT管理器功能函数（新增编码转换） ==========
        let mtHistory = [];
        let mtHistoryIndex = -1;

        function readMtFile(input) {
            if (!input.files.length) return;
            const file = input.files[0];
            document.getElementById('mtFileNameDisplay').textContent = file.name;
            document.getElementById('mtFileName').value = file.name;
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('mtEditContent').value = e.target.result;
                mtRecordHistory();
            };
            reader.readAsText(file);
        }

        function mtRecordHistory() {
            const content = document.getElementById('mtEditContent').value;
            if (mtHistoryIndex >= 0 && mtHistory[mtHistoryIndex] === content) return;
            mtHistory = mtHistory.slice(0, mtHistoryIndex + 1);
            mtHistory.push(content);
            mtHistoryIndex = mtHistory.length - 1;
        }

        function mtSelectAll() {
            const editor = document.getElementById('mtEditContent');
            editor.focus();
            editor.select();
        }

        function mtCopy() {
            mtSelectAll();
            document.execCommand('copy');
            alert('复制成功！');
        }

        function mtCut() {
            mtSelectAll();
            document.execCommand('cut');
            mtRecordHistory();
            alert('剪切成功！');
        }

        function mtPaste() {
            document.getElementById('mtEditContent').focus();
            document.execCommand('paste');
            mtRecordHistory();
            alert('粘贴成功！');
        }

        function mtUndo() {
            if (mtHistoryIndex <= 0) return alert('无法撤销！');
            mtHistoryIndex--;
            document.getElementById('mtEditContent').value = mtHistory[mtHistoryIndex];
        }

        function mtRedo() {
            if (mtHistoryIndex >= mtHistory.length - 1) return alert('无法重做！');
            mtHistoryIndex++;
            document.getElementById('mtEditContent').value = mtHistory[mtHistoryIndex];
        }

        function mtFind() {
            const modal = document.getElementById('findReplaceModal');
            document.getElementById('modalTitle').textContent = "查找";
            document.getElementById('replaceInputWrap').style.display = "none";
            document.getElementById('replaceBtn').style.display = "none";
            document.getElementById('replaceAllBtn').style.display = "none";
            document.getElementById('findBtn').style.display = "block";
            modal.style.display = "flex";
            document.getElementById('findText').focus();
        }

        function mtReplace() {
            const modal = document.getElementById('findReplaceModal');
            document.getElementById('modalTitle').textContent = "查找并替换";
            document.getElementById('replaceInputWrap').style.display = "block";
            document.getElementById('replaceBtn').style.display = "block";
            document.getElementById('replaceAllBtn').style.display = "block";
            document.getElementById('findBtn').style.display = "block";
            modal.style.display = "flex";
            document.getElementById('findText').focus();
        }

        function doFind() {
            const content = document.getElementById('mtEditContent').value;
            const findText = document.getElementById('findText').value.trim();
            if (!findText) return alert('请输入查找内容！');
            const editor = document.getElementById('mtEditContent');
            const index = content.indexOf(findText, editor.selectionEnd);
            if (index === -1) return alert('未找到内容！');
            editor.focus();
            editor.setSelectionRange(index, index + findText.length);
            editor.scrollTop = (index / content.length) * editor.scrollHeight;
        }

        function doReplace() {
            const editor = document.getElementById('mtEditContent');
            const findText = document.getElementById('findText').value.trim();
            const replaceText = document.getElementById('replaceText').value;
            if (!findText) return alert('请输入查找内容！');
            if (editor.selectionStart === editor.selectionEnd) return doFind();
            if (editor.value.substring(editor.selectionStart, editor.selectionEnd) === findText) {
                editor.value = editor.value.substring(0, editor.selectionStart) + replaceText + editor.value.substring(editor.selectionEnd);
                editor.setSelectionRange(editor.selectionStart, editor.selectionStart + replaceText.length);
                mtRecordHistory();
            }
            doFind();
        }

        function doReplaceAll() {
            const findText = document.getElementById('findText').value.trim();
            const replaceText = document.getElementById('replaceText').value;
            if (!findText) return alert('请输入查找内容！');
            const editor = document.getElementById('mtEditContent');
            const newContent = editor.value.split(findText).join(replaceText);
            editor.value = newContent;
            mtRecordHistory();
            alert(`替换完成！共替换 ${(editor.value.split(replaceText).length - 1)} 处`);
            closeModal();
        }

        function closeModal() {
            document.getElementById('findReplaceModal').style.display = "none";
            document.getElementById('charsetModal').style.display = "none";
        }

        function mtFormatJson() {
            const content = document.getElementById('mtEditContent').value.trim();
            if (!content) return alert('暂无内容可格式化！');
            try {
                const json = JSON.parse(content);
                document.getElementById('mtEditContent').value = JSON.stringify(json, null, 2);
                mtRecordHistory();
                alert('JSON格式化成功！');
            } catch (e) {
                alert('不是有效的JSON格式！');
            }
        }

        function mtMinify() {
            const content = document.getElementById('mtEditContent').value.trim();
            if (!content) return alert('暂无内容可压缩！');
            document.getElementById('mtEditContent').value = content.replace(/\s+/g, ' ').trim();
            mtRecordHistory();
            alert('代码压缩成功！');
        }

        function mtLineCount() {
            const content = document.getElementById('mtEditContent').value;
            const lines = content.split('\n').length;
            alert(`总行数：${lines} 行`);
        }

        function mtSaveFile() {
            const content = document.getElementById('mtEditContent').value.trim();
            if (!content) return alert('暂无内容可保存！');
            const fileName = document.getElementById('mtFileName').value.trim() || "mt_file.txt";
            const blob = new Blob([content], { type: 'application/octet-stream' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function mtNewFile() {
            document.getElementById('mtEditContent').value = '';
            document.getElementById('mtFileName').value = 'new_file.txt';
            document.getElementById('mtFileNameDisplay').textContent = "未选择文件";
            document.getElementById('mtFileInput').value = '';
            mtRecordHistory();
        }

        function mtClearContent() {
            document.getElementById('mtEditContent').value = '';
            mtRecordHistory();
        }

        // ========== 新增：编码转换核心功能 ==========
        function openCharsetModal() {
            // 弹窗默认选中当前编码
            const currentCharset = document.getElementById('mtCharset').value;
            document.getElementById('charsetFrom').value = currentCharset;
            document.getElementById('charsetModal').style.display = "flex";
        }

        function convertCharset() {
            const content = document.getElementById('mtEditContent').value;
            if (!content) return alert('暂无内容可转换！');

            const fromCharset = document.getElementById('charsetFrom').value;
            const toCharset = document.getElementById('charsetTo').value;

            if (fromCharset === toCharset) return alert('原编码与目标编码相同，无需转换！');

            try {
                // 使用 iconv-lite 进行编码转换
                const buffer = iconvLite.encode(content, fromCharset);
                const converted = iconvLite.decode(buffer, toCharset);
                
                document.getElementById('mtEditContent').value = converted;
                document.getElementById('mtCharset').value = toCharset;
                mtRecordHistory();
                alert(`编码转换成功：${fromCharset.toUpperCase()} → ${toCharset.toUpperCase()}`);
                closeModal();
            } catch (e) {
                alert(`编码转换失败：${e.message}`);
            }
        }
    </script>
</body>
</html>
