<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    <title>IPTV工具集 - 全量繁转简</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", Arial, sans-serif;
        }
        body {
            background: #f5f5f5;
            padding: 15px;
            max-width: 100%;
            margin: 0 auto;
        }
        /* 面板切换按钮 */
        .tab-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-btn {
            flex: 1;
            padding: 12px 0;
            border: none;
            border-radius: 8px;
            background: #e5e5e5;
            color: #333;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab-btn.active {
            background: #1677ff;
            color: #fff;
        }
        /* 面板容器 */
        .panel-container {
            width: 100%;
        }
        .panel {
            display: none;
            background: #fff;
            padding: 20px 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,.08);
        }
        .panel.active {
            display: block;
        }
        h1 {
            font-size: 18px;
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-weight: 600;
        }
        /* LOGO搜索面板样式 */
        .logo-search h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
            font-weight: 500;
        }
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            width: 100%;
        }
        .search-bar input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        .search-bar button {
            padding: 0 20px;
            background: #1677ff;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
        }
        .loading {
            text-align: center;
            color: #1677ff;
            font-size: 14px;
            padding: 20px;
            display: none;
        }
        .logo-result {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            display: none;
        }
        .logo-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
        }
        .logo-item:last-child {
            border-bottom: none;
        }
        .logo-item:hover {
            background: #e8f4ff;
        }
        .logo-item .preview {
            width: 60px;
            height: 30px;
            border: 1px solid #eee;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: zoom-in;
        }
        .logo-item .preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.2s;
        }
        .logo-item .preview img:hover {
            transform: scale(1.05);
        }
        .logo-item .preview .placeholder {
            color: #999;
            font-size: 10px;
        }
        .logo-item .info {
            flex: 1;
        }
        .logo-item .name {
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
        }
        .logo-item .url {
            font-size: 12px;
            color: #666;
            word-break: break-all;
        }
        .logo-item .copy-btn {
            padding: 4px 12px;
            font-size: 12px;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
            background: #1677ff;
        }
        /* IPTV处理面板样式 */
        .input-item {
            margin-bottom: 15px;
            width: 100%;
        }
        .input-item label {
            font-size: 14px;
            color: #555;
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
        }
        input, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
            font-size: 14px;
        }
        textarea {
            min-height: 180px;
            resize: vertical;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            font-size: 14px;
            color: #555;
        }
        .checkbox-item input {
            margin-right: 8px;
            width: 18px;
            height: 18px;
        }
        .btn-group {
            display: flex;
            gap: 8px;
            margin: 15px 0;
            flex-wrap: wrap;
            width: 100%;
        }
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: #1677ff;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
        }
        button.gray {
            background: #666;
        }
        .func-btn {
            display: flex;
            gap: 8px;
            margin: 15px 0;
            flex-wrap: wrap;
            width: 100%;
        }
        .upload {
            margin: 15px 0;
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        .upload input {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .upload-btn {
            display: block;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
            font-size: 14px;
            color: #555;
            text-align: center;
        }
        .upload-tip {
            margin-top: 8px;
            font-size: 12px;
            color: #999;
        }
        .custom-clean-tip {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }
        /* LOGO放大预览弹窗 */
        .logo-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }
        .logo-preview-content {
            max-width: 90%;
            max-height: 80%;
            position: relative;
        }
        .logo-preview-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }
        .logo-preview-close {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #ff4d4f;
            color: #fff;
            border: none;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="tab-group">
        <button class="tab-btn active" onclick="switchTab('iptv-panel')">IPTV文件处理</button>
        <button class="tab-btn" onclick="switchTab('logo-panel')">LOGO模糊搜索</button>
    </div>

    <div class="panel-container">
        <!-- IPTV文件处理面板 -->
        <div class="panel active" id="iptv-panel">
            <h1>IPTV工具集 - 全量繁转简</h1>
            <!-- EPG地址 -->
            <div class="input-item">
                <label>EPG 地址</label>
                <input id="epgUrl" placeholder="请输入EPG地址" value="https://epg.catvod.com/epg.xml">
            </div>
            <!-- Logo基础地址 -->
            <div class="input-item">
                <label>Logo 基础地址（结尾 /）</label>
                <input id="logoUrlInput" placeholder="请输入Logo基础地址" value="https://cdn.jsdelivr.net/gh/1996TV/LOGO@main/">
            </div>
            <!-- 自定义净化关键词输入框 -->
            <div class="input-item">
                <label>自定义净化关键词</label>
                <input id="customCleanKeywords" placeholder="多个关键词用英文逗号分隔，如:测试,备用,无效">
                <div class="custom-clean-tip">提示：输入后会和默认关键词（高清|HD|超清）一起过滤频道名</div>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="cleanName" checked>
                <label>净化频道名</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="removeReplay" checked>
                <label>去除回看 / 回放 / 时移频道</label>
            </div>
            <div class="input-item">
                <label>旧链接前缀</label>
                <input id="oldLinkPrefix" placeholder="如http://old.com/">
            </div>
            <div class="input-item">
                <label>新链接前缀</label>
                <input id="newLinkPrefix" placeholder="如http://new.com/">
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="enableLinkReplace" checked>
                <label>启用链接替换（转换文件时自动生效）</label>
            </div>
            <!-- 全量繁转简开关 -->
            <div class="checkbox-item">
                <input type="checkbox" id="enableFullCnConvert" checked>
                <label>启用全量繁转简（所有操作自动生效）</label>
            </div>
            <!-- 修复文件上传区域 -->
            <div class="input-item">
                <label>上传文件</label>
                <div class="upload">
                    <span class="upload-btn" id="uploadBtnText">选取文件</span>
                    <input type="file" id="fileInput" accept=".txt,.m3u,.m3u8" onchange="handleFileUpload(this)">
                </div>
                <div class="upload-tip" id="fileTip">支持.txt/.m3u格式，文件编码为UTF-8</div>
            </div>
            <textarea id="inputContent" placeholder="粘贴或上传 TXT / M3U 内容"></textarea>
            
            <div class="btn-group">
                <button onclick="txtToM3u()">TXT → M3U</button>
                <button onclick="m3uToTxt()">M3U → TXT</button>
                <button onclick="onlyReplaceLink()">只替换链接</button>
                <button onclick="fullTraditionalToSimplified()">强制繁转简</button>
                <button onclick="clearAll()">清空内容</button>
            </div>
            <div class="func-btn">
                <button onclick="downloadResult()">下载结果</button>
                <button onclick="copyResult()">复制结果</button>
            </div>
            <textarea id="output" placeholder="处理结果" readonly></textarea>
        </div>

        <!-- LOGO模糊搜索面板 -->
        <div class="panel" id="logo-panel">
            <h1>LOGO模糊搜索</h1>
            <div class="logo-search">
                <div class="search-bar">
                    <input type="text" id="searchKey" placeholder="输入关键词（如CCTV、4K、BBC）">
                    <button onclick="fuzzySearchLogo()">搜索LOGO</button>
                </div>
                <div class="loading" id="loading">正在拉取LOGO列表...</div>
                <div id="logoResult" class="logo-result"></div>
            </div>
        </div>
    </div>

    <!-- LOGO放大预览弹窗 -->
    <div class="logo-preview-modal" id="logoPreviewModal" onclick="closeLogoPreview()">
        <div class="logo-preview-content" onclick="event.stopPropagation()">
            <img src="" alt="LOGO预览" class="logo-preview-img" id="previewImg">
            <button class="logo-preview-close" onclick="closeLogoPreview()">×</button>
        </div>
    </div>

    <script>
        // 仓库配置
        const repoOwner = "1996TV";
        const repoName = "LOGO";
        const cdnBase = `https://cdn.jsdelivr.net/gh/${repoOwner}/${repoName}@main/`;
        let allLogoFiles = [];
        // 常量配置
        const DEFAULT_EPG_URL = "https://epg.catvod.com/epg.xml";
        const DEFAULT_LOGO_URL = "https://cdn.jsdelivr.net/gh/1996TV/LOGO@main/";
        const DEFAULT_CLEAN_KEYWORDS = ["高清", "HD", "超清"];
        const CONFIG_STORAGE_KEY = "iptv_tool_config";

        // ========== 面板切换核心函数 ==========
        function switchTab(panelId) {
            // 切换按钮状态
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // 切换面板显示
            document.querySelectorAll('.panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(panelId).classList.add('active');
        }

        // ========== LOGO名称标准化函数 ==========
        function normalizeLogoName(name) {
            // 1. 去除所有空格和标点符号
            const noSpacePunct = name.replace(/[\s\p{P}]/gu, '');
            // 2. 转换为小写
            return noSpacePunct.toLowerCase();
        }

        // ========== 核心：全量繁简字符映射表（基于OpenCC开源字典） ==========
        const FULL_TRAD_TO_SIMP = new Map([
            ["臺","台"],["灣","湾"],["華","华"],["僑","侨"],["鄉","乡"],["儀","仪"],["價","价"],["個","个"],["幾","几"],
            ["兒","儿"],["係","系"],["餘","余"],["億","亿"],["萬","万"],["禮","礼"],["體","体"],["麵","面"],["鬥","斗"],
            ["蘇","苏"],["聯","联"],["愛","爱"],["親","亲"],["樂","乐"],["藝","艺"],["術","术"],["經","经"],["營","营"],
            ["發","发"],["達","达"],["麼","么"],["這","这"],["裡","里"],["後","后"],["範","范"],["豐","丰"],["灘","滩"],
            ["過","过"],["國","国"],["學","学"],["園","园"],["運","运"],["動","动"],["態","态"],["戰","战"],["電","电"],
            ["視","视"],["話","话"],["計","计"],["機","机"],["車","车"],["長","长"],["間","间"],["時","时"],["訊","讯"],
            ["種","种"],["從","从"],["來","来"],["對","对"],["隊","队"],["員","员"],["會","会"],["議","议"],["語","语"],
            ["僅","仅"],["顯","显"],["書","书"],["寫","写"],["數","数"],["據","据"],["點","点"],["與","与"],["註","注"],
            ["釋","释"],["總","总"],["結","结"],["論","论"],["問","问"],["題","题"],["現","现"],["象","象"],["析","析"],
            ["設","设"],["開","开"],["展","展"],["狀","状"],["況","况"],["則","则"],["礎","础"],["提","提"],["解","解"],
            ["決","决"],["案","案"],["實","实"],["施","施"],["效","效"],["檢","检"],["驗","验"],["證","证"],["確","确"],
            ["保","保"],["充","充"],["足","足"],["夠","够"],["需","需"],["必","必"],["須","须"],["應","应"],["該","该"],
            ["將","将"],["完","完"],["成","成"],["標","标"],["指","指"],["達","达"],["超","超"],["預","预"],["期","期"],
            ["嚴","严"],["格","格"],["執","执"],["行","行"],["規","规"],["制","制"],["度","度"],["遵","遵"],["守","守"],
            ["紀","纪"],["律","律"],["秩","秩"],["序","序"],["安","安"],["全","全"],["生","生"],["產","产"],["順","顺"],
            ["利","利"],["暢","畅"],["穩","稳"],["定","定"],["和","和"],["諧","谐"],["平","平"],["幸","幸"],["福","福"],
            ["快","快"],["健","健"],["康","康"],["壽","寿"],["美","美"],["滿","满"],["圓","圆"],["冊","册"],["冪","幂"],
            ["冩","写"],["匯","汇"],["區","区"],["奮","奋"],["奪","夺"],["奧","奥"],["妝","妆"],["婦","妇"],["嫚","嫚"],
            ["嬌","娇"],["嬰","婴"],["寢","寝"],["審","审"],["尋","寻"],["導","导"],["爾","尔"],["彌","弥"],["彥","彦"],
            ["影","影"],["德","德"],["徵","征"],["徑","径"],["待","待"],["律","律"],["後","后"],["復","复"],["循","循"],
            ["微","微"],["徹","彻"],["慶","庆"],["憶","忆"],["懷","怀"],["憤","愤"],["憂","忧"],["應","应"],["愛","爱"],
            ["感","感"],["慾","欲"],["歡","欢"],["歐","欧"],["殺","杀"],["毅","毅"],["毆","殴"],["毖","毖"],["氫","氢"],
            ["氬","氩"],["氧","氧"],["氮","氮"],["氯","氯"],["氖","氖"],["水","水"],["氷","冰"],["永","永"],["沖","冲"],
            ["決","决"],["況","况"],["泉","泉"],["泊","泊"],["沿","沿"],["泡","泡"],["注","注"],["灑","洒"],["淚","泪"],
            ["淨","净"],["滅","灭"],["溝","沟"],["漢","汉"],["滬","沪"],["滙","汇"],["滿","满"],["濃","浓"],["濟","济"],
            ["瀝","沥"],["瀘","泸"],["瀋","沈"],["瀏","浏"],["瀑","瀑"],["火","火"],["災","灾"],["灰","灰"],["炭","炭"],
            ["炮","炮"],["燈","灯"],["燒","烧"],["燙","烫"],["爛","烂"],["爐","炉"],["爪","爪"],["爬","爬"],["爭","争"],
            ["爰","爰"],["爲","为"],["疏","疏"],["發","发"],["皺","皱"],["盞","盏"],["盟","盟"],["監","监"],["盤","盘"],
            ["盜","盗"],["眞","真"],["眡","视"],["眛","昧"],["眞","真"],["矩","矩"],["短","短"],["矮","矮"],["知","知"],
            ["秀","秀"],["私","私"],["積","积"],["稱","称"],["秘","秘"],["秉","秉"],["科","科"],["秒","秒"],["秋","秋"],
            ["種","种"],["稅","税"],["程","程"],["積","积"],["稚","稚"],["稱","称"],["稈","秆"],["稻","稻"],["穀","谷"],
            ["穗","穗"],["穫","获"],["穎","颖"],["錢","钱"],["鐘","钟"],["鈔","钞"],["銀","银"],["銅","铜"],["鐵","铁"],
            ["銹","锈"],["鋁","铝"],["鋼","钢"],["鋪","铺"],["鍋","锅"],["鐘","钟"],["鏡","镜"],["鏈","链"],["鎖","锁"],
            ["鑰","钥"],["鑽","钻"],["鑄","铸"],["鑑","鉴"],["鑽","钻"],["長","长"],["門","门"],["閃","闪"],["閉","闭"],
            ["問","问"],["聞","闻"],["閩","闽"],["閣","阁"],["閨","闺"],["閭","闾"],["閱","阅"],["離","离"],["雜","杂"],
            ["難","难"],["隱","隐"],["隸","隶"],["隨","随"],["隊","队"],["陽","阳"],["陰","阴"],["陣","阵"],["階","阶"],
            ["際","际"],["陸","陆"],["陳","陈"],["陶","陶"],["陷","陷"],["陣","阵"],["歸","归"],["鄉","乡"],["長","长"],
            ["附","附"],["院","院"],["隊","队"],["限","限"],["降","降"],["隔","隔"],["障","障"],["際","际"],["陸","陆"],
            ["陰","阴"],["陽","阳"],["雄","雄"],["雅","雅"],["集","集"],["雇","雇"],["雞","鸡"],["雨","雨"],["雪","雪"],
            ["雷","雷"],["雹","雹"],["霜","霜"],["霞","霞"],["露","露"],["靂","雳"],["靄","霭"],["青","青"],["靜","静"],
            ["靚","靓"],["靠","靠"],["面","面"],["革","革"],["靴","靴"],["靶","靶"],["鞍","鞍"],["鞘","鞘"],["鞠","鞠"],
            ["鞭","鞭"],["韌","韧"],["響","响"],["頁","页"],["頂","顶"],["項","项"],["順","顺"],["須","须"],["頓","顿"],
            ["頒","颁"],["頂","顶"],["頡","颉"],["頃","顷"],["顆","颗"],["顏","颜"],["顯","显"],["顧","顾"],["風","风"],
            ["飛","飞"],["食","食"],["飢","饥"],["飯","饭"],["飲","饮"],["飼","饲"],["飾","饰"],["飽","饱"],["飼","饲"],
            ["養","养"],["館","馆"],["餅","饼"],["餃","饺"],["餓","饿"],["餘","余"],["餐","餐"],["館","馆"],["馥","馥"],
            ["馬","马"],["馳","驰"],["馮","冯"],["駕","驾"],["駛","驶"],["駐","驻"],["驚","惊"],["驕","骄"],["驟","骤"],
            ["驗","验"],["騷","骚"],["騰","腾"],["騙","骗"],["騷","骚"],["骨","骨"],["體","体"],["髮","发"],["鬚","须"],
            ["鬢","鬓"],["鬥","斗"],["鬧","闹"],["鬨","哄"],["鬚","须"],["高","高"],["髒","脏"],["鬆","松"],["鼠","鼠"],
            ["鼻","鼻"],["齊","齐"],["齒","齿"],["齡","龄"],["齒","齿"],["龍","龙"],["龜","龟"]
        ]);

        // 全量繁转简核心函数
        function convertTraditionalToSimplified(text) {
            if (!text) return "";
            let result = "";
            for (const char of text) {
                result += FULL_TRAD_TO_SIMP.has(char) ? FULL_TRAD_TO_SIMP.get(char) : char;
            }
            return result;
        }

        // ========== 修复文件上传核心函数 ==========
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) {
                document.getElementById("uploadBtnText").textContent = "选取文件";
                document.getElementById("fileTip").textContent = "支持.txt/.m3u格式，文件编码为UTF-8";
                return;
            }

            // 显示文件名
            document.getElementById("uploadBtnText").textContent = `已选：${file.name}`;
            document.getElementById("fileTip").textContent = `文件大小：${(file.size / 1024).toFixed(2)}KB`;

            // 创建FileReader，指定编码为UTF-8（修复苹果乱码问题）
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let content = e.target.result;
                    // 若开启繁转简，转换后再显示
                    if (document.getElementById("enableFullCnConvert").checked) {
                        content = convertTraditionalToSimplified(content);
                    }
                    // 填入输入框并触发渲染
                    const inputContent = document.getElementById("inputContent");
                    inputContent.value = content;
                    // 修复Safari文本域渲染延迟
                    inputContent.dispatchEvent(new Event('input', { bubbles: true }));
                    alert(`文件读取成功！共${content.split('\n').length}行内容`);
                } catch (err) {
                    alert(`文件读取失败：${err.message}`);
                    console.error("文件读取错误：", err);
                }
            };

            // 处理不同编码（优先UTF-8，兼容GBK）
            if (file.name.endsWith(".txt") || file.name.endsWith(".m3u")) {
                reader.readAsText(file, "UTF-8");
            } else {
                alert("仅支持.txt和.m3u格式文件！");
                input.value = "";
                document.getElementById("uploadBtnText").textContent = "选取文件";
            }
        }

        // ========== 页面加载时重置状态 ==========
        window.onload = function() {
            localStorage.removeItem(CONFIG_STORAGE_KEY);
            history.replaceState(null, null, window.location.href);
            document.getElementById('epgUrl').value = DEFAULT_EPG_URL;
            document.getElementById('logoUrlInput').value = DEFAULT_LOGO_URL;
            document.getElementById('searchKey').value = '';
            document.getElementById('customCleanKeywords').value = '';
            document.getElementById('oldLinkPrefix').value = '';
            document.getElementById('newLinkPrefix').value = '';
            document.getElementById('inputContent').value = '';
            document.getElementById('output').value = '';
            document.getElementById('cleanName').checked = true;
            document.getElementById('removeReplay').checked = true;
            document.getElementById('enableLinkReplace').checked = true;
            document.getElementById('enableFullCnConvert').checked = true;
        }

        function saveConfig() { return; }
        function loadConfig() { return; }

        // ========== LOGO放大预览功能 ==========
        function openLogoPreview(imgUrl) {
            const modal = document.getElementById('logoPreviewModal');
            const previewImg = document.getElementById('previewImg');
            previewImg.src = imgUrl;
            modal.style.display = 'flex';
        }
        function closeLogoPreview() {
            const modal = document.getElementById('logoPreviewModal');
            modal.style.display = 'none';
        }

        // LOGO模糊搜索
        async function fuzzySearchLogo() {
            const key = document.getElementById('searchKey').value.trim().toLowerCase();
            if (!key) {
                alert('请输入关键词！');
                return;
            }
            const loading = document.getElementById('loading');
            const resultBox = document.getElementById('logoResult');
            
            loading.style.display = 'block';
            resultBox.style.display = 'none';
            try {
                if (allLogoFiles.length === 0) {
                    await fetchLogoFiles();
                }
                const matchFiles = allLogoFiles.filter(file => 
                    file.name.toLowerCase().includes(key)
                );
                loading.style.display = 'none';
                resultBox.style.display = 'block';
                
                if (matchFiles.length === 0) {
                    resultBox.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">未找到匹配的LOGO文件</p>';
                    return;
                }
                let resultHtml = '';
                matchFiles.forEach(file => {
                    const logoName = file.name.replace('.png', '');
                    const logoCdnUrl = cdnBase + file.name;
                    resultHtml += `
                        <div class="logo-item">
                            <div class="preview" onclick="openLogoPreview('${logoCdnUrl}')">
                                <img src="${logoCdnUrl}" alt="${logoName}" onerror="this.parentNode.innerHTML='<span class=placeholder>加载失败</span>'">
                            </div>
                            <div class="info">
                                <div class="name">${logoName}</div>
                                <div class="url">${logoCdnUrl}</div>
                            </div>
                            <button class="copy-btn" onclick="copyLogoUrl('${logoCdnUrl}')">复制链接</button>
                        </div>
                    `;
                });
                resultBox.innerHTML = resultHtml;
            } catch (error) {
                loading.style.display = 'none';
                resultBox.style.display = 'block';
                resultBox.innerHTML = `<p style="text-align:center; color:#f5222d; padding:20px;">搜索失败：${error.message}</p>`;
                console.error('LOGO搜索失败', error);
            }
        }

        async function fetchLogoFiles() {
            const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/`;
            const response = await fetch(apiUrl);
            
            if (!response.ok) {
                throw new Error(`GitHub API请求失败（${response.status}）`);
            }
            const files = await response.json();
            allLogoFiles = files
                .filter(file => file.type === 'file' && file.name.endsWith('.png'))
                .map(file => ({ name: file.name, downloadUrl: file.download_url }));
        }

        function copyLogoUrl(url) {
            navigator.clipboard.writeText(url)
                .then(() => alert('LOGO链接复制成功！'))
                .catch(() => {
                    const textarea = document.createElement('textarea');
                    textarea.value = url;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('LOGO链接复制成功！');
                });
        }

        // ========== 强制繁转简函数 ==========
        function fullTraditionalToSimplified() {
            const inputContent = document.getElementById('inputContent').value.trim();
            if (!inputContent) {
                alert('请先输入或上传内容！');
                return;
            }
            try {
                const simplifiedContent = convertTraditionalToSimplified(inputContent);
                document.getElementById('inputContent').value = simplifiedContent;
                alert('全量繁转简完成！');
            } catch (err) {
                alert('转换失败！请刷新页面重试');
                console.error('转换错误:', err);
            }
        }

        // ========== 统一链接替换函数 ==========
        function replaceLink(url) {
            if (!document.getElementById('enableLinkReplace').checked) return url;
            const oldPrefix = document.getElementById('oldLinkPrefix').value.trim();
            const newPrefix = document.getElementById('newLinkPrefix').value.trim();
            if (!oldPrefix || !newPrefix) return url;
            return url.replace(new RegExp(oldPrefix, 'g'), newPrefix);
        }

        // 下载功能
        function downloadResult() {
            const content = document.getElementById('output').value.trim();
            if (!content) return alert('暂无内容可下载！');
            const ext = content.startsWith('#EXTM3U') ? 'm3u' : 'txt';
            const fileName = `iptv.${ext}`;
            try {
                const blob = new Blob([content], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.target = '_self';
                document.body.appendChild(a);
                const event = new MouseEvent('click', {
                    bubbles: true,
                    cancelable: true,
                    view: window
                });
                a.dispatchEvent(event);
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert(`✅ 下载已触发`);
                }, 1000);
            } catch (e1) {
                console.error('Blob方案失败，尝试降级方案', e1);
                try {
                    const dataUri = `data:application/octet-stream;charset=utf-8,${encodeURIComponent(content)}`;
                    const a = document.createElement('a');
                    a.href = dataUri;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        alert(`✅ 降级方案下载成功`);
                    }, 500);
                } catch (e2) {
                    console.error('降级方案也失败', e2);
                    alert(`⚠️ 自动下载失败\n请点击【复制结果】按钮，手动粘贴到备忘录保存`);
                }
            }
        }

        function copyResult() {
            const content = document.getElementById('output').value.trim();
            if (!content) return alert('暂无内容可复制！');
            navigator.clipboard.writeText(content)
                .then(() => alert('结果复制成功！可粘贴到备忘录保存'))
                .catch(() => {
                    const ta = document.createElement('textarea');
                    ta.value = content;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    alert('结果复制成功！');
                });
        }

        // 自定义净化频道名函数
        function cleanNameFn(n) {
            if (!document.getElementById('cleanName').checked) return n;
            
            let customKeywords = document.getElementById('customCleanKeywords').value.split(',').map(k => k.trim()).filter(k => k);
            let allKeywords = [...DEFAULT_CLEAN_KEYWORDS, ...customKeywords];
            
            let cleanedName = n;
            allKeywords.forEach(keyword => {
                cleanedName = cleanedName.replace(keyword, '');
            });
            return cleanedName.trim();
        }

        function isReplay(n) {
            return /(回看|回放|时移|Replay|Catchup|重播)/i.test(n);
        }

        // ========== TXT→M3U 核心修改：LOGO名称标准化匹配 ==========
        function txtToM3u() {
            const epg = document.getElementById('epgUrl').value.trim();
            const logoBase = document.getElementById('logoUrlInput').value.replace(/\/$/, '') + '/';
            let input = document.getElementById('inputContent').value.trim();
            if (!input) return alert('请输入TXT内容！');
            
            // 若开启繁转简，转换前执行繁转简
            if (document.getElementById('enableFullCnConvert').checked) {
                input = convertTraditionalToSimplified(input);
            }
            const lines = input.split('\n');
            let output = `#EXTM3U x-tvg-url="${epg}"\n`;
            let group = '';
            lines.forEach(l => {
                l = l.trim();
                if (!l) return;
                if (l.endsWith(',#genre#')) {
                    group = l.replace(',#genre#', '');
                    return;
                }
                if (!l.includes(',')) return;
                const [name, url] = l.split(',');
                if (document.getElementById('removeReplay').checked && isReplay(name)) return;
                
                const cleanName = cleanNameFn(name);
                const playUrl = replaceLink(url);

                // 关键修改：标准化频道名用于匹配LOGO
                const normalizedChannelName = normalizeLogoName(cleanName);
                // 遍历LOGO文件，找到标准化后匹配的文件
                let matchedLogo = '';
                if (allLogoFiles.length > 0) {
                    for (let file of allLogoFiles) {
                        const logoFileName = file.name.replace('.png', '');
                        const normalizedLogoName = normalizeLogoName(logoFileName);
                        if (normalizedLogoName === normalizedChannelName) {
                            matchedLogo = logoBase + file.name;
                            break;
                        }
                    }
                }
                
                output += `#EXTINF:-1 tvg-name="${cleanName}" tvg-logo="${matchedLogo}" group-title="${group}",${cleanName}\n${playUrl}\n`;
            });
            document.getElementById('output').value = output;
        }

        // ========== M3U→TXT ==========
        function m3uToTxt() {
            let input = document.getElementById('inputContent').value.trim();
            if (!input) return alert('请输入M3U内容！');
            
            // 若开启繁转简，转换前执行繁转简
            if (document.getElementById('enableFullCnConvert').checked) {
                input = convertTraditionalToSimplified(input);
            }
            const lines = input.split('\n');
            let output = '';
            let currentGroup = '';
            let currentName = '';
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                if (line.startsWith('#EXTM3U')) continue;
                if (line.startsWith('#EXTINF')) {
                    // 提取分组和名称
                    const groupMatch = line.match(/group-title="([^"]+)"/);
                    const nameMatch = line.match(/,(.*)$/);
                    if (groupMatch) currentGroup = groupMatch[1];
                    if (nameMatch) currentName = nameMatch[1];
                } else if (line.startsWith('http')) {
                    const url = replaceLink(line);
                    if (document.getElementById('removeReplay').checked && isReplay(currentName)) continue;
                    const cleanName = cleanNameFn(currentName);
                    // 输出分组标记
                    if (currentGroup && !output.includes(`${currentGroup},#genre#`)) {
                        output += `${currentGroup},#genre#\n`;
                    }
                    output += `${cleanName},${url}\n`;
                }
            }
            document.getElementById('output').value = output;
        }

        // ========== 单独替换链接 ==========
        function onlyReplaceLink() {
            let input = document.getElementById('inputContent').value.trim();
            if (!input) return alert('请输入内容！');
            
            // 若开启开关，替换前执行繁转简
            if (document.getElementById('enableFullCnConvert').checked) {
                input = convertTraditionalToSimplified(input);
            }
            const oldPrefix = document.getElementById('oldLinkPrefix').value.trim();
            const newPrefix = document.getElementById('newLinkPrefix').value.trim();
            if (!oldPrefix || !newPrefix) return alert('请填写完整的新旧链接前缀！');
            
            let output = input.replace(new RegExp(oldPrefix, 'g'), newPrefix);
            document.getElementById('output').value = output;
        }

        function clearAll() {
            document.getElementById('inputContent').value = '';
            document.getElementById('output').value = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadBtnText').textContent = '选取文件';
            document.getElementById('fileTip').textContent = '支持.txt/.m3u格式，文件编码为UTF-8';
        }
    </script>
</body>
</html>
